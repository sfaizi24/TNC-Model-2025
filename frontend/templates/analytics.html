{% extends "base.html" %}

{% block title %}Analytics - Fantasy Football Analytics{% endblock %}

{% block content %}
<style>
    .page-header {
        margin-bottom: 30px;
    }
    
    .page-title {
        font-size: 32px;
        color: var(--text-primary);
        margin-bottom: 10px;
    }
    
    .page-subtitle {
        color: var(--text-secondary);
        font-size: 16px;
    }
    
    .section {
        margin-bottom: 50px;
    }
    
    .section-title {
        font-size: 24px;
        color: var(--fanduel-blue);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--fanduel-light-gray);
    }
    
    .edge-to-edge-image {
        width: 100vw;
        margin-left: calc(-50vw + 50%);
        display: block;
    }
    
    .roster-divider {
        margin: 20px 0;
        padding: 10px 0;
        border-top: 2px solid var(--fanduel-light-gray);
        border-bottom: 2px solid var(--fanduel-light-gray);
        text-align: center;
        color: var(--text-secondary);
        font-weight: 600;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    @media (min-width: 768px) {
        .page-title {
            font-size: 42px;
        }
    }
</style>

<div class="page-header">
    <h1 class="page-title">Research teams and view league-wide analytics</h1>
</div>

<div style="margin-bottom: 30px;">
    <label for="team-select" style="display: block; font-size: 16px; color: var(--text-primary); margin-bottom: 10px; font-weight: 600;">Select Team:</label>
    <select id="team-select" style="width: 100%; max-width: 400px; padding: 12px 15px; font-size: 16px; background: var(--fanduel-gray); color: var(--text-primary); border: 1px solid var(--fanduel-light-gray); border-radius: 8px; cursor: pointer;">
        <option value="all">All Teams</option>
        <!-- Teams will be loaded dynamically -->
    </select>
</div>

<div id="team-distribution" class="section">
    <img id="distribution-image" src="/static/images/simulation_distributions_overlay_week_10.png" alt="Team Distribution" class="edge-to-edge-image" decoding="async">
</div>

<div id="team-players" class="section" style="display: none;">
    <h2 class="section-title">Team Roster & Projections</h2>
    <div id="players-table-container"></div>
</div>

<div class="section">
    <img src="/static/images/simulation_boxplot_week_10.png" alt="Box Plot Comparison" class="edge-to-edge-image" loading="lazy" decoding="async">
</div>

<script>
// Load teams on page load
async function loadTeams() {
    try {
        const response = await fetch('/api/teams');
        const data = await response.json();
        const select = document.getElementById('team-select');
        const existingAllOption = select.querySelector('option[value="all"]');
        select.innerHTML = '';

        const allOption = existingAllOption || document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'All Teams';
        allOption.selected = true;
        select.appendChild(allOption);

        data.teams.forEach(team => {
            const option = document.createElement('option');
            option.value = team;
            option.textContent = `Team ${team}`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading teams:', error);
    }
}

// Handle team selection
document.getElementById('team-select').addEventListener('change', async function() {
    const selectedTeam = this.value;
    const distributionImage = document.getElementById('distribution-image');
    const playersSection = document.getElementById('team-players');
    const playersContainer = document.getElementById('players-table-container');
    
    if (selectedTeam === 'all') {
        distributionImage.src = '/static/images/simulation_distributions_overlay_week_10.png';
        playersSection.style.display = 'none';
    } else {
        distributionImage.src = `/static/images/dist_Team_${selectedTeam}_week_10.png`;
        playersSection.style.display = 'block';
        
        try {
            const teamParam = encodeURIComponent(selectedTeam);
            const response = await fetch(`/api/team_players?team=${teamParam}`);
            const data = await response.json();
            
            if ((data.starters && data.starters.length > 0) || (data.bench && data.bench.length > 0)) {
                let html = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; background: var(--fanduel-gray); border-radius: 12px; overflow: hidden; border: 1px solid var(--fanduel-light-gray);">
                            <thead>
                                <tr style="background: var(--fanduel-darker); border-bottom: 2px solid var(--fanduel-blue);">
                                    <th style="padding: 15px; text-align: left; color: var(--fanduel-blue); font-weight: 600;">Player</th>
                                    <th style="padding: 15px; text-align: center; color: var(--fanduel-blue); font-weight: 600;">Position</th>
                                    <th style="padding: 15px; text-align: right; color: var(--fanduel-blue); font-weight: 600;">Projected Points</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                let rowIndex = 0;
                
                if (data.starters && data.starters.length > 0) {
                    data.starters.forEach((player) => {
                        html += `
                            <tr style="border-bottom: 1px solid var(--fanduel-light-gray); ${rowIndex % 2 === 0 ? 'background: rgba(20, 147, 255, 0.05);' : ''}">
                                <td style="padding: 12px 15px; color: var(--text-primary);">${player.player_first_name} ${player.player_last_name}</td>
                                <td style="padding: 12px 15px; text-align: center; color: var(--text-secondary); font-weight: 600;">${player.position}</td>
                                <td style="padding: 12px 15px; text-align: right; color: var(--fanduel-blue); font-weight: 600; font-size: 18px;">${player.mu.toFixed(1)}</td>
                            </tr>
                        `;
                        rowIndex++;
                    });
                }
                
                if (data.bench && data.bench.length > 0) {
                    html += `
                        <tr>
                            <td colspan="3" class="roster-divider">Bench Players</td>
                        </tr>
                    `;
                    
                    data.bench.forEach((player) => {
                        html += `
                            <tr style="border-bottom: 1px solid var(--fanduel-light-gray); ${rowIndex % 2 === 0 ? 'background: rgba(20, 147, 255, 0.05);' : ''}">
                                <td style="padding: 12px 15px; color: var(--text-primary);">${player.player_first_name} ${player.player_last_name}</td>
                                <td style="padding: 12px 15px; text-align: center; color: var(--text-secondary); font-weight: 600;">${player.position}</td>
                                <td style="padding: 12px 15px; text-align: right; color: var(--fanduel-blue); font-weight: 600; font-size: 18px;">${player.mu.toFixed(1)}</td>
                            </tr>
                        `;
                        rowIndex++;
                    });
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                playersContainer.innerHTML = html;
            } else {
                playersContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 30px;">No player data available for this team.</p>';
            }
        } catch (error) {
            console.error('Error loading players:', error);
            playersContainer.innerHTML = '<p style="color: var(--text-danger); text-align: center; padding: 30px;">Error loading player data.</p>';
        }
    }
});

// Load teams on page load
loadTeams();
</script>
{% endblock %}

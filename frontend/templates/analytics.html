{% extends "base.html" %}

{% block title %}Analytics - Fantasy Football Analytics{% endblock %}

{% block content %}
<style>
    .page-header {
        margin-bottom: 30px;
    }
    
    .page-title {
        font-size: 32px;
        color: var(--text-primary);
        margin-bottom: 10px;
    }
    
    .page-subtitle {
        color: var(--text-secondary);
        font-size: 16px;
    }
    
    .section {
        margin-bottom: 50px;
    }
    
    .section-title {
        font-size: 24px;
        color: var(--fanduel-blue);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--fanduel-light-gray);
    }
    
    .image-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    
    .image-card {
        background: var(--fanduel-gray);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--fanduel-light-gray);
        transition: all 0.3s ease;
    }
    
    .image-card:hover {
        transform: translateY(-5px);
        border-color: var(--fanduel-blue);
        box-shadow: 0 8px 25px rgba(20, 147, 255, 0.15);
    }
    
    .image-card img {
        width: 100%;
        height: auto;
        display: block;
    }
    
    .image-caption {
        padding: 15px 20px;
        font-weight: 600;
        color: var(--text-primary);
        background: var(--fanduel-darker);
        border-top: 1px solid var(--fanduel-light-gray);
    }
    
    @media (min-width: 768px) {
        .page-title {
            font-size: 42px;
        }
        
        .image-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }
    }
</style>

<div class="page-header">
    <h1 class="page-title">Analytics Dashboard</h1>
    <p class="page-subtitle">Monte Carlo Simulations & Betting Odds Analysis - Week 10</p>
</div>

<div style="margin-bottom: 30px;">
    <label for="team-select" style="display: block; font-size: 16px; color: var(--text-primary); margin-bottom: 10px; font-weight: 600;">Select Team:</label>
    <select id="team-select" style="width: 100%; max-width: 400px; padding: 12px 15px; font-size: 16px; background: var(--fanduel-gray); color: var(--text-primary); border: 1px solid var(--fanduel-light-gray); border-radius: 8px; cursor: pointer;">
        <option value="all">All Teams</option>
        <!-- Teams will be loaded dynamically -->
    </select>
</div>

<div id="team-distribution" class="section">
    <img id="distribution-image" src="/static/images/simulation_distributions_overlay_week_10.png" alt="Team Distribution" style="width: 100%; max-width: 1200px; border-radius: 12px; border: 1px solid var(--fanduel-light-gray);" decoding="async">
</div>

<div id="team-players" class="section" style="display: none;">
    <h2 class="section-title">Team Roster & Projections</h2>
    <div id="players-table-container"></div>
</div>

<div class="section">
    <h2 class="section-title">Monte Carlo Simulation Results</h2>
    <div class="image-grid">
        <div class="image-card">
            <img src="/static/images/simulation_distributions_week_10.png" alt="Team Distributions" loading="lazy" decoding="async">
            <div class="image-caption">Team Score Distributions</div>
        </div>
        <div class="image-card">
            <img src="/static/images/simulation_boxplot_week_10.png" alt="Box Plot Comparison" loading="lazy" decoding="async">
            <div class="image-caption">Box Plot Comparison</div>
        </div>
        <div class="image-card">
            <img src="/static/images/simulation_violin_week_10.png" alt="Violin Plot" loading="lazy" decoding="async">
            <div class="image-caption">Violin Plot with Percentiles</div>
        </div>
        <div class="image-card">
            <img src="/static/images/win_probability_heatmap_week_10.png" alt="Win Probability" loading="lazy" decoding="async">
            <div class="image-caption">Win Probability Heatmap</div>
        </div>
        <div class="image-card">
            <img src="/static/images/percentile_ranges_week_10.png" alt="Percentile Ranges" loading="lazy" decoding="async">
            <div class="image-caption">Percentile Ranges</div>
        </div>
        <div class="image-card">
            <img src="/static/images/cdf_plot_week_10.png" alt="CDF Plot" loading="lazy" decoding="async">
            <div class="image-caption">Cumulative Distribution Functions</div>
        </div>
    </div>
</div>

<div class="section">
    <h2 class="section-title">Betting Odds Analysis</h2>
    <div class="image-grid">
        <div class="image-card">
            <img src="/static/images/betting_odds_high_low_week_10.png" alt="High/Low Scorer Odds" loading="lazy" decoding="async">
            <div class="image-caption">Highest & Lowest Scorer Odds</div>
        </div>
        <div class="image-card">
            <img src="/static/images/betting_odds_moneyline_week_10.png" alt="Moneyline Odds" loading="lazy" decoding="async">
            <div class="image-caption">Matchup Moneyline Odds</div>
        </div>
    </div>
</div>

<div style="text-align: center; margin-top: 50px; padding: 30px; border-top: 1px solid var(--fanduel-light-gray);">
    <p style="color: var(--text-secondary); margin-bottom: 10px;">Data aggregated from multiple sources: Sleeper, ESPN, FantasyPros, FanDuel, FirstDown</p>
    <p style="color: var(--text-secondary); font-size: 14px;">Generated from Monte Carlo simulations (N=50,000) based on player projections</p>
</div>

<script>
// Load teams on page load
async function loadTeams() {
    try {
        const response = await fetch('/api/teams');
        const data = await response.json();
        const select = document.getElementById('team-select');
        const existingAllOption = select.querySelector('option[value="all"]');
        select.innerHTML = '';

        const allOption = existingAllOption || document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'All Teams';
        allOption.selected = true;
        select.appendChild(allOption);

        data.teams.forEach(team => {
            const option = document.createElement('option');
            option.value = team;
            option.textContent = `Team ${team}`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading teams:', error);
    }
}

// Handle team selection
document.getElementById('team-select').addEventListener('change', async function() {
    const selectedTeam = this.value;
    const distributionImage = document.getElementById('distribution-image');
    const playersSection = document.getElementById('team-players');
    const playersContainer = document.getElementById('players-table-container');
    
    if (selectedTeam === 'all') {
        // Show overlay image for all teams
        distributionImage.src = '/static/images/simulation_distributions_overlay_week_10.png';
        playersSection.style.display = 'none';
    } else {
        // Show specific team distribution
        distributionImage.src = `/static/images/dist_Team_${selectedTeam}_week_10.png`;
        playersSection.style.display = 'block';
        
        // Load player stats for this team
        try {
            const teamParam = encodeURIComponent(selectedTeam);
            const response = await fetch(`/api/team_players?team=${teamParam}`);
            const data = await response.json();
            
            if (data.players && data.players.length > 0) {
                let html = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; background: var(--fanduel-gray); border-radius: 12px; overflow: hidden; border: 1px solid var(--fanduel-light-gray);">
                            <thead>
                                <tr style="background: var(--fanduel-darker); border-bottom: 2px solid var(--fanduel-blue);">
                                    <th style="padding: 15px; text-align: left; color: var(--fanduel-blue); font-weight: 600;">Player</th>
                                    <th style="padding: 15px; text-align: center; color: var(--fanduel-blue); font-weight: 600;">Position</th>
                                    <th style="padding: 15px; text-align: right; color: var(--fanduel-blue); font-weight: 600;">Projected Points</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.players.forEach((player, index) => {
                    html += `
                        <tr style="border-bottom: 1px solid var(--fanduel-light-gray); ${index % 2 === 0 ? 'background: rgba(20, 147, 255, 0.05);' : ''}">
                            <td style="padding: 12px 15px; color: var(--text-primary);">${player.player_first_name} ${player.player_last_name}</td>
                            <td style="padding: 12px 15px; text-align: center; color: var(--text-secondary); font-weight: 600;">${player.position}</td>
                            <td style="padding: 12px 15px; text-align: right; color: var(--fanduel-blue); font-weight: 600; font-size: 18px;">${player.mu.toFixed(1)}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                playersContainer.innerHTML = html;
            } else {
                playersContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 30px;">No player data available for this team.</p>';
            }
        } catch (error) {
            console.error('Error loading players:', error);
            playersContainer.innerHTML = '<p style="color: var(--text-danger); text-align: center; padding: 30px;">Error loading player data.</p>';
        }
    }
});

// Load teams on page load
loadTeams();
</script>
{% endblock %}

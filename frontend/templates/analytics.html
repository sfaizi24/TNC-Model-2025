{% extends "base.html" %}

{% block title %}Analytics - Fantasy Football Analytics{% endblock %}

{% block content %}
<style>
    .page-header {
        margin-bottom: 20px;
    }
    
    .page-title {
        font-size: 20px;
        color: var(--text-primary);
        margin-bottom: 8px;
    }
    
    .page-subtitle {
        color: var(--text-secondary);
        font-size: 16px;
    }
    
    .section {
        margin-bottom: 40px;
    }
    
    .section-title {
        font-size: 18px;
        color: var(--fanduel-blue);
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--fanduel-light-gray);
    }
    
    .edge-to-edge-image {
        width: 100vw;
        margin-left: calc(-50vw + 50%);
        display: block;
    }
    
    .roster-divider {
        margin: 20px 0;
        padding: 10px 0;
        border-top: 2px solid var(--fanduel-light-gray);
        border-bottom: 2px solid var(--fanduel-light-gray);
        text-align: center;
        color: var(--text-secondary);
        font-weight: 600;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    @media (min-width: 768px) {
        .page-title {
            font-size: 28px;
        }
    }
</style>

<div class="page-header">
    <h1 class="page-title">Research Teams and View League-wide Analytics</h1>
</div>

<div style="margin-bottom: 20px;">
    <label for="team-select" style="display: block; font-size: 14px; color: var(--text-primary); margin-bottom: 8px; font-weight: 600;">Select Team:</label>
    <select id="team-select" style="width: 100%; max-width: 400px; padding: 10px 12px; font-size: 14px; background: var(--fanduel-gray); color: var(--text-primary); border: 1px solid var(--fanduel-light-gray); border-radius: 8px; cursor: pointer;">
        <option value="all">All Teams</option>
        <!-- Teams will be loaded dynamically -->
    </select>
    <div id="teams-error" style="display: none; margin-top: 12px; padding: 12px; background: rgba(220, 38, 38, 0.1); border: 1px solid rgba(220, 38, 38, 0.3); border-radius: 8px; color: #ef4444; font-size: 13px;"></div>
</div>

<div id="team-distribution" class="section">
    <img id="distribution-image" src="/analytics-images/simulation_distributions_overlay_week_{{ current_week }}.png" alt="Team Distribution" class="edge-to-edge-image" decoding="async">
</div>

<div id="team-players" class="section" style="display: none;">
    <h2 class="section-title">Team Roster & Projections</h2>
    <div id="players-table-container"></div>
</div>

<div class="section">
    <img src="/analytics-images/simulation_boxplot_week_{{ current_week }}.png" alt="Box Plot Comparison" class="edge-to-edge-image" loading="lazy" decoding="async">
</div>

<script>
const currentWeek = {{ current_week }};

// Helper function for fetch with timeout
async function fetchWithTimeout(url, options = {}, timeout = 10000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);
    
    try {
        const response = await fetch(url, {
            ...options,
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        return response;
    } catch (error) {
        clearTimeout(timeoutId);
        throw error;
    }
}

// Show error message
function showError(message, shouldRedirect = false) {
    const errorDiv = document.getElementById('teams-error');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    
    if (shouldRedirect) {
        setTimeout(() => {
            window.location.href = '/login';
        }, 2000);
    }
}

// Hide error message
function hideError() {
    const errorDiv = document.getElementById('teams-error');
    errorDiv.style.display = 'none';
}

// Check if user session is valid
// Returns: { authenticated: true/false, error: null/'timeout'/'network' }
async function checkSession() {
    try {
        const response = await fetchWithTimeout('/api/session-check', {}, 5000);
        if (response.status === 401) {
            return { authenticated: false, error: null };
        }
        const data = await response.json();
        return { authenticated: data.authenticated, error: null };
    } catch (error) {
        console.error('Session check failed:', error);
        if (error.name === 'AbortError') {
            return { authenticated: null, error: 'timeout' };
        } else if (error.message.includes('Failed to fetch')) {
            return { authenticated: null, error: 'network' };
        }
        return { authenticated: null, error: 'unknown' };
    }
}

// Load teams on page load
async function loadTeams() {
    hideError();
    
    try {
        const sessionResult = await checkSession();
        
        // Handle session check errors
        if (sessionResult.error) {
            if (sessionResult.error === 'timeout') {
                showError('Session check timed out. Please refresh the page and try again.');
            } else if (sessionResult.error === 'network') {
                showError('Unable to connect to server. Please check your connection and refresh the page.');
            } else {
                showError('Error checking session. Please refresh the page and try again.');
            }
            return;
        }
        
        // Handle expired session
        if (!sessionResult.authenticated) {
            showError('Your session has expired. Redirecting to login...', true);
            return;
        }
        
        const response = await fetchWithTimeout('/api/teams', {}, 10000);
        
        if (!response.ok) {
            if (response.status === 401) {
                showError('Your session has expired. Redirecting to login...', true);
                return;
            }
            throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        const select = document.getElementById('team-select');
        const existingAllOption = select.querySelector('option[value="all"]');
        select.innerHTML = '';

        const allOption = existingAllOption || document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'All Teams';
        allOption.selected = true;
        select.appendChild(allOption);

        data.teams.forEach(team => {
            const option = document.createElement('option');
            option.value = team.slug;
            option.textContent = team.label;
            select.appendChild(option);
        });
        
        hideError();
    } catch (error) {
        console.error('Error loading teams:', error);
        
        if (error.name === 'AbortError') {
            showError('Request timed out. Please refresh the page and try again.');
        } else if (error.message.includes('Failed to fetch')) {
            showError('Unable to connect to server. Please check your connection and try again.');
        } else {
            showError('Failed to load teams. Please refresh the page and try again.');
        }
    }
}

// Handle team selection
document.getElementById('team-select').addEventListener('change', async function() {
    const selectedTeam = this.value;
    const distributionImage = document.getElementById('distribution-image');
    const playersSection = document.getElementById('team-players');
    const playersContainer = document.getElementById('players-table-container');
    
    if (selectedTeam === 'all') {
        distributionImage.src = `/analytics-images/simulation_distributions_overlay_week_${currentWeek}.png`;
        playersSection.style.display = 'none';
    } else {
        distributionImage.src = `/analytics-images/dist_Team_${selectedTeam}_week_${currentWeek}.png`;
        playersSection.style.display = 'block';
        
        playersContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading players...</div>';
        
        try {
            const teamParam = encodeURIComponent(selectedTeam);
            const response = await fetchWithTimeout(`/api/team_players?team=${teamParam}`, {}, 10000);
            
            if (!response.ok) {
                if (response.status === 401) {
                    showError('Your session has expired. Redirecting to login...', true);
                    return;
                }
                throw new Error(`Server error: ${response.status}`);
            }
            
            const data = await response.json();
            
            if ((data.starters && data.starters.length > 0) || (data.bench && data.bench.length > 0)) {
                let html = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; background: var(--fanduel-gray); border-radius: 12px; overflow: hidden; border: 1px solid var(--fanduel-light-gray);">
                            <thead>
                                <tr style="background: var(--fanduel-darker); border-bottom: 2px solid var(--fanduel-blue);">
                                    <th style="padding: 8px 10px; text-align: left; color: var(--fanduel-blue); font-weight: 600; font-size: 12px;">Player</th>
                                    <th style="padding: 8px 10px; text-align: center; color: var(--fanduel-blue); font-weight: 600; font-size: 12px;">Pos</th>
                                    <th style="padding: 8px 10px; text-align: right; color: var(--fanduel-blue); font-weight: 600; font-size: 12px;">Proj</th>
                                    <th style="padding: 8px 10px; text-align: right; color: var(--fanduel-blue); font-weight: 600; font-size: 12px;">Var</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                let rowIndex = 0;
                
                if (data.starters && data.starters.length > 0) {
                    data.starters.forEach((player) => {
                        const muDisplay = player.mu !== null ? player.mu.toFixed(1) : '-';
                        const varDisplay = player.var !== null ? player.var.toFixed(1) : '-';
                        html += `
                            <tr style="border-bottom: 1px solid var(--fanduel-light-gray); ${rowIndex % 2 === 0 ? 'background: rgba(20, 147, 255, 0.05);' : ''}">
                                <td style="padding: 6px 8px; color: var(--text-primary); font-size: 13px;">${player.player_first_name} ${player.player_last_name}</td>
                                <td style="padding: 6px 8px; text-align: center; color: var(--text-secondary); font-weight: 600; font-size: 12px;">${player.position}</td>
                                <td style="padding: 6px 8px; text-align: right; color: var(--fanduel-blue); font-weight: 600; font-size: 14px;">${muDisplay}</td>
                                <td style="padding: 6px 8px; text-align: right; color: var(--text-secondary); font-weight: 600; font-size: 13px;">${varDisplay}</td>
                            </tr>
                        `;
                        rowIndex++;
                    });
                }
                
                if (data.bench && data.bench.length > 0) {
                    html += `
                        <tr>
                            <td colspan="4" class="roster-divider">Bench Players</td>
                        </tr>
                    `;
                    
                    data.bench.forEach((player) => {
                        const muDisplay = player.mu !== null ? player.mu.toFixed(1) : '-';
                        const varDisplay = player.var !== null ? player.var.toFixed(1) : '-';
                        html += `
                            <tr style="border-bottom: 1px solid var(--fanduel-light-gray); ${rowIndex % 2 === 0 ? 'background: rgba(20, 147, 255, 0.05);' : ''}">
                                <td style="padding: 6px 8px; color: var(--text-primary); font-size: 13px;">${player.player_first_name} ${player.player_last_name}</td>
                                <td style="padding: 6px 8px; text-align: center; color: var(--text-secondary); font-weight: 600; font-size: 12px;">${player.position}</td>
                                <td style="padding: 6px 8px; text-align: right; color: var(--fanduel-blue); font-weight: 600; font-size: 14px;">${muDisplay}</td>
                                <td style="padding: 6px 8px; text-align: right; color: var(--text-secondary); font-weight: 600; font-size: 13px;">${varDisplay}</td>
                            </tr>
                        `;
                        rowIndex++;
                    });
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                playersContainer.innerHTML = html;
            } else {
                playersContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 30px;">No player data available for this team.</p>';
            }
        } catch (error) {
            console.error('Error loading players:', error);
            
            let errorMessage = 'Error loading player data.';
            if (error.name === 'AbortError') {
                errorMessage = 'Request timed out. Please try again.';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Unable to connect to server. Please check your connection.';
            }
            
            playersContainer.innerHTML = `<p style="color: #ef4444; text-align: center; padding: 30px;">${errorMessage}</p>`;
        }
    }
});

// Load teams on page load
loadTeams();
</script>
{% endblock %}
